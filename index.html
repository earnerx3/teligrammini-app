<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Rewards App</title>
    <!-- Telegram Web App Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --background: #0A0F1F;
            --card-bg: #11182D;
            --primary: #00F5D4;
            --primary-glow: rgba(0, 245, 212, 0.3);
            --text-primary: #FFFFFF;
            --text-secondary: #94A3B8;
            --border-color: rgba(148, 163, 184, 0.1);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .primary-btn { background-color: var(--primary); color: #0A0F1F; font-weight: 700; transition: all 0.3s ease; box-shadow: 0 0 15px var(--primary-glow); }
        .primary-btn:hover { transform: scale(1.05); box-shadow: 0 0 25px var(--primary-glow); }
        .glassmorphism { background: rgba(17, 24, 45, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-top: 1px solid var(--border-color); }
        .nav-item.active svg, .nav-item.active p { color: var(--primary); }
        .nav-item.active .active-indicator { width: 8px; height: 8px; background-color: var(--primary); border-radius: 50%; margin-top: 4px; box-shadow: 0 0 10px var(--primary-glow); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page { animation: fadeIn 0.4s ease-out; display: none; }
        .page.active { display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .progress-ring__circle { transition: stroke-dashoffset 0.35s; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-[var(--background)] text-[var(--text-primary)]">

    <div id="app-container" class="max-w-md mx-auto min-h-screen flex flex-col relative overflow-hidden hidden">
        <!-- Main Content -->
        <main class="flex-grow p-4 pb-24 overflow-y-auto no-scrollbar">
            <!-- Pages will be injected here -->
            <div id="home" class="page space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[var(--text-secondary)]">Welcome,</p>
                        <h2 id="user-name" class="text-2xl font-bold">User</h2>
                    </div>
                    <div id="user-avatar" class="w-12 h-12 rounded-full bg-cover bg-center border-2 border-[var(--primary)]"></div>
                </div>
                <div class="card p-6 rounded-2xl text-center border-2 border-[var(--primary)] shadow-[0_0_30px_var(--primary-glow)]">
                    <p class="text-sm text-[var(--text-secondary)]">Total Balance</p>
                    <p id="balance" class="text-4xl font-extrabold mt-2">0 Pts</p>
                </div>
                <div class="card p-4 rounded-2xl">
                    <h3 class="font-bold mb-3 text-lg">Daily Ads Progress</h3>
                    <div class="flex items-center space-x-4">
                        <div class="relative w-16 h-16">
                            <svg class="w-full h-full" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--card-bg)" stroke-width="3.8"/><path id="ad-progress-circle" class="progress-ring__circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--primary)" stroke-width="3.8" stroke-linecap="round"/></svg>
                            <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-sm font-bold" id="ad-progress-text">0/30</div>
                        </div>
                        <div><p class="font-bold text-white">You've watched <span id="ads-watched-count-home">0</span> of 30 ads.</p><p class="text-sm text-[var(--text-secondary)]">Watch more ads to earn points!</p></div>
                    </div>
                </div>
            </div>

            <div id="tasks" class="page space-y-6">
                 <h2 class="text-2xl font-bold text-center">Tasks & Rewards</h2>
                <div class="card p-6 rounded-2xl text-center">
                    <h3 class="font-bold text-xl mb-4">Watch Ads & Earn</h3>
                    <div class="relative w-32 h-32 mx-auto mb-4">
                        <svg class="w-full h-full" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--card-bg)" stroke-width="3.8"/><path id="ad-progress-circle-tasks" class="progress-ring__circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--primary)" stroke-width="3.8" stroke-linecap="round"/></svg>
                        <div class="absolute top-0 left-0 w-full h-full flex flex-col items-center justify-center"><span id="ads-watched-count-tasks" class="text-3xl font-bold">0</span><span class="text-sm text-[var(--text-secondary)]">/ 30 Ads</span></div>
                    </div>
                    <button id="watch-ad-btn" class="primary-btn w-full py-3 rounded-lg">Watch Ad (+15 Pts)</button>
                </div>
            </div>
            
            <div id="refer" class="page space-y-6">
                <h2 class="text-2xl font-bold text-center">Refer & Earn</h2>
                <div class="card p-6 rounded-2xl text-center">
                    <p class="text-[var(--text-secondary)]">Total Referrals</p>
                    <p id="referral-count" class="text-5xl font-extrabold my-2">0</p>
                    <p class="text-sm text-[var(--primary)]">+100 Points for each successful referral!</p>
                </div>
                <div class="card p-4 rounded-2xl">
                    <label class="text-sm text-[var(--text-secondary)]">Your Referral Link</label>
                    <div class="relative mt-2">
                        <input id="referral-link" type="text" readonly class="w-full bg-[var(--background)] border border-[var(--border-color)] rounded-lg p-3 pr-12 text-sm">
                        <button onclick="copyReferralLink()" class="absolute inset-y-0 right-0 flex items-center px-3 text-[var(--primary)]">Copy</button>
                    </div>
                    <p id="copy-success" class="text-center text-sm text-[var(--primary)] mt-2 hidden">Link copied!</p>
                </div>
            </div>

            <div id="profile" class="page space-y-6">
                 <div class="flex flex-col items-center text-center">
                    <div id="profile-avatar" class="w-24 h-24 rounded-full bg-cover bg-center border-4 border-[var(--primary)] shadow-[0_0_20px_var(--primary-glow)]"></div>
                    <h2 id="profile-name" class="font-bold text-2xl mt-4">User</h2>
                    <p id="profile-username" class="text-[var(--text-secondary)] text-sm">@username</p>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                     <div class="card p-4 rounded-xl text-center"><p class="text-sm text-[var(--text-secondary)]">Total Earned</p><p id="total-earned" class="text-2xl font-bold mt-1">0 Pts</p></div>
                     <div class="card p-4 rounded-xl text-center"><p class="text-sm text-[var(--text-secondary)]">Referral Bonus</p><p id="referral-bonus" class="text-2xl font-bold mt-1">0 Pts</p></div>
                 </div>
            </div>
        </main>

        <footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto glassmorphism">
            <div class="flex justify-around py-2">
                <button data-page="home" class="nav-item flex flex-col items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg><p class="text-xs mt-1">Home</p><div class="active-indicator"></div></button>
                <button data-page="tasks" class="nav-item flex flex-col items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><p class="text-xs mt-1">Tasks</p><div class="active-indicator" style="display: none;"></div></button>
                <button data-page="refer" class="nav-item flex flex-col items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 11h-6"/><path d="M19 8v6"/></svg><p class="text-xs mt-1">Refer</p><div class="active-indicator" style="display: none;"></div></button>
                <button data-page="profile" class="nav-item flex flex-col items-center w-20"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><p class="text-xs mt-1">Profile</p><div class="active-indicator" style="display: none;"></div></button>
            </div>
        </footer>
    </div>
    
    <!-- Loading/Error State -->
    <div id="loading-state" class="flex items-center justify-center min-h-screen text-center p-4">
        <div>
            <p id="loading-text" class="text-lg">Connecting to server...</p>
        </div>
    </div>
    
    <!-- Ad Modal -->
    <div id="ad-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden">
        <div class="card rounded-2xl p-6 text-center w-64"><h3 class="font-bold text-lg">Watching Ad...</h3><div class="relative w-24 h-24 mx-auto my-4"><svg class="w-full h-full" viewBox="0 0 36 36"><path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--card-bg)" stroke-width="3.8"/><path id="ad-timer-circle" class="progress-ring__circle" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="var(--primary)" stroke-width="3.8" stroke-linecap="round" stroke-dasharray="100, 100" stroke-dashoffset="100"/></svg><div id="ad-timer-text" class="absolute top-0 left-0 w-full h-full flex items-center justify-center text-2xl font-bold">30</div></div><p class="text-sm text-[var(--text-secondary)]">Please wait for the reward.</p></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
          apiKey: "AIzaSyCJB3VeZ-eYiCBSM6ht_7L07GnDMZg6OHQ",
          authDomain: "myuser-d62cc.firebaseapp.com",
          projectId: "myuser-d62cc",
          storageBucket: "myuser-d62cc.firebasestorage.app",
          messagingSenderId: "906917838947",
          appId: "1:906917838947:web:4c83c8e142536d35e3f856",
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const tg = window.Telegram.WebApp;

        let state = {
            userId: null,
            userData: {},
            dailyAdLimit: 30,
        };

        function showLoadingError(message) {
            document.getElementById('loading-text').innerText = message;
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');
        }

        async function init() {
            try {
                tg.ready();
                tg.expand();
                
                if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                    showLoadingError('Error: Please open this app through Telegram.');
                    return;
                }
                
                const user = tg.initDataUnsafe.user;
                state.userId = user.id.toString();

                const userDocRef = doc(db, "users", state.userId);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists()) {
                    // New user creation
                    const newUser = {
                        telegramId: user.id,
                        firstName: user.first_name,
                        lastName: user.last_name || '',
                        username: user.username || '',
                        balance: 0,
                        adsWatched: 0,
                        lastAdWatchDate: '',
                        referralCount: 0,
                        totalEarned: 0,
                        referralBonus: 0,
                        createdAt: new Date().toISOString(),
                    };
                    await setDoc(userDocRef, newUser);
                    
                    // Handle referral
                    const urlParams = new URLSearchParams(window.location.search);
                    const refId = urlParams.get('startapp');
                    if (refId && refId !== state.userId) {
                        const referrerDocRef = doc(db, "users", refId);
                        await updateDoc(referrerDocRef, {
                            balance: increment(100),
                            referralCount: increment(1),
                            referralBonus: increment(100)
                        });
                        await updateDoc(userDocRef, { referredBy: refId });
                    }
                }

                // Real-time listener for user data
                onSnapshot(userDocRef, (doc) => {
                    if (doc.exists()) {
                        state.userData = doc.data();
                        updateUI();
                    }
                });

                document.getElementById('loading-state').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                navigateTo('home');

            } catch (error) {
                console.error("Initialization Error:", error);
                showLoadingError('Failed to initialize. Please try again.');
            }
        }
        
        function updateUI() {
            const { balance = 0, firstName = 'User', username, referralCount = 0, totalEarned = 0, referralBonus = 0 } = state.userData;
            document.getElementById('balance').textContent = `${balance.toFixed(0)} Pts`;
            document.getElementById('user-name').textContent = firstName;
            document.getElementById('profile-name').textContent = firstName;
            document.getElementById('profile-username').textContent = username ? `@${username}` : 'No username';
            
            const avatarUrl = `https://placehold.co/100x100/11182D/00F5D4?text=${firstName.charAt(0)}`;
            document.getElementById('user-avatar').style.backgroundImage = `url('${avatarUrl}')`;
            document.getElementById('profile-avatar').style.backgroundImage = `url('${avatarUrl}')`;

            // Ads Progress
            const today = new Date().toISOString().split('T')[0];
            let adsWatchedToday = state.userData.lastAdWatchDate === today ? state.userData.adsWatched : 0;
            const adProgress = (adsWatchedToday / state.dailyAdLimit) * 100;
            const radius = 15.9155;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (adProgress / 100) * circumference;
            
            ['ad-progress-circle', 'ad-progress-circle-tasks'].forEach(id => {
                const circle = document.getElementById(id);
                if(circle) {
                    circle.style.strokeDasharray = `${circumference} ${circumference}`;
                    circle.style.strokeDashoffset = offset;
                }
            });

            document.getElementById('ad-progress-text').textContent = `${adsWatchedToday}/${state.dailyAdLimit}`;
            document.getElementById('ads-watched-count-home').textContent = adsWatchedToday;
            document.getElementById('ads-watched-count-tasks').textContent = adsWatchedToday;

            // Refer page
            document.getElementById('referral-count').textContent = referralCount;
            const botUsername = "YOUR_TELEGRAM_BOT_USERNAME"; // TODO: Replace with your bot username
            document.getElementById('referral-link').value = `https://t.me/${botUsername}/YOUR_APP_NAME?startapp=${state.userId}`;
            
            // Profile page
            document.getElementById('total-earned').textContent = `${totalEarned.toFixed(0)} Pts`;
            document.getElementById('referral-bonus').textContent = `${referralBonus.toFixed(0)} Pts`;

            // Button state
            const watchAdBtn = document.getElementById('watch-ad-btn');
            watchAdBtn.disabled = adsWatchedToday >= state.dailyAdLimit;
            watchAdBtn.style.opacity = watchAdBtn.disabled ? '0.5' : '1';
        }
        
        // Navigation Logic
        const pages = document.querySelectorAll('.page');
        const navItems = document.querySelectorAll('.nav-item');
        window.navigateTo = function(pageId) {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            navItems.forEach(item => {
                const indicator = item.querySelector('.active-indicator');
                const isActive = item.dataset.page === pageId;
                item.classList.toggle('active', isActive);
                if (indicator) indicator.style.display = isActive ? 'block' : 'none';
            });
        }
        navItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)));

        // Ad Logic
        document.getElementById('watch-ad-btn').addEventListener('click', async () => {
            const today = new Date().toISOString().split('T')[0];
            let adsWatchedToday = state.userData.lastAdWatchDate === today ? state.userData.adsWatched : 0;
            if (adsWatchedToday >= state.dailyAdLimit) return;
            
            const adModal = document.getElementById('ad-modal');
            adModal.classList.remove('hidden');

            let timeLeft = 5; // Using 5 seconds for quick demo
            const timerText = document.getElementById('ad-timer-text');
            const timerCircle = document.getElementById('ad-timer-circle');
            const radius = 15.9155;
            const circumference = 2 * Math.PI * radius;
            
            const interval = setInterval(() => {
                timeLeft--;
                timerText.textContent = timeLeft;
                timerCircle.style.strokeDashoffset = circumference - ((timeLeft/5)/100) * circumference;
                if(timeLeft <= 0) {
                    clearInterval(interval);
                    adModal.classList.add('hidden');
                    rewardUserForAd();
                }
            }, 1000);
        });

        async function rewardUserForAd() {
            const userDocRef = doc(db, "users", state.userId);
            const today = new Date().toISOString().split('T')[0];
            const newAdsWatched = state.userData.lastAdWatchDate === today ? increment(1) : 1;
            
            await updateDoc(userDocRef, {
                balance: increment(15),
                totalEarned: increment(15),
                adsWatched: newAdsWatched,
                lastAdWatchDate: today
            });
        }
        
        // Referral Link Copy
        window.copyReferralLink = function() {
            const linkInput = document.getElementById('referral-link');
            navigator.clipboard.writeText(linkInput.value).then(() => {
                const successMsg = document.getElementById('copy-success');
                successMsg.classList.remove('hidden');
                setTimeout(() => successMsg.classList.add('hidden'), 2000);
            });
        }

        init();
    </script>
</body>
</html>

