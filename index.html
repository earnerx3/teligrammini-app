<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earning App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Updated Ad Script with the new data-zone -->
    <script src='//libtl.com/sdk.js' data-zone='10058398' data-sdk='show_10058398'></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
    
    <style>
        :root {
            --primary-gold: #f39c12;
            --secondary-gold: #e67e22;
            --primary-dark: #1a1a2e;
            --secondary-dark: #16213e;
            --light-bg: #f8f9fa;
            --text-dark: #1a1a2e;
            --text-light: #ffffff;
            --text-muted: #7f8c8d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #101827 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: var(--light-bg);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.5);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid rgba(243, 156, 18, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-profile {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary-gold);
        }

        .header-info h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .header-info p {
            font-size: 12px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Icon Styles */
        .icon {
            width: 16px;
            height: 16px;
            vertical-align: middle;
        }
        .icon-lg {
            width: 24px;
            height: 24px;
        }
        .icon-xl {
            width: 40px;
            height: 40px;
        }

        /* Page Transitions */
        .page {
            display: none;
            padding: 20px;
            padding-bottom: 100px; /* Space for bottom nav */
            animation: fadeIn 0.4s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page.active {
            display: block;
        }

        /* Balance Card */
        .balance-card {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            border-radius: 20px;
            padding: 25px;
            color: var(--text-light);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.4);
        }
        
        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(243, 156, 18, 0.15) 0%, transparent 70%);
        }

        .balance-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .balance-info h3 {
            font-size: 18px;
            margin-bottom: 2px;
        }

        .balance-amount {
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dollar-equivalent {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .balance-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            border-top: 1px solid rgba(243, 156, 18, 0.3);
            padding-top: 20px;
            text-align: center;
        }
        
        .balance-stat h4 {
            font-size: 20px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .balance-stat p {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
        }

        /* Card Styles */
        .card {
            background: var(--text-light);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .card-header h3 {
            font-size: 18px;
            color: var(--text-dark);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: rgba(243, 156, 18, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card-desc {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* Buttons */
        .btn {
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-gold) 0%, var(--secondary-gold) 100%);
            color: var(--text-light);
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(243, 156, 18, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
            color: var(--text-light);
            box-shadow: 0 8px 25px rgba(26, 26, 46, 0.3);
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(26, 26, 46, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        
        /* Task Page */
        .task-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .overview-item h3 {
            font-size: 24px;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        
        .overview-item p {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .task-actions .btn {
            margin-bottom: 15px;
        }
        
        .task-progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 25px;
            height: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold));
            border-radius: 25px;
            transition: width 0.5s ease-in-out;
        }

        .task-list-container {
            margin-top: 25px;
        }

        .task-item {
            background: #ffffff;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .task-item-info {
            flex-grow: 1;
        }

        .task-item h4 {
            font-size: 16px;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .task-item p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .task-item button {
            background: var(--primary-gold);
            color: var(--text-light);
            border: none;
            border-radius: 10px;
            padding: 8px 15px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }

        .task-item button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 400px;
            background: var(--text-light);
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.3s ease;
            border-radius: 10px;
            min-width: 60px;
            padding: 8px 0;
        }

        .nav-item.active {
            color: var(--primary-gold);
            transform: translateY(-3px);
        }
        
        .nav-item svg {
            width: 24px;
            height: 24px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
        }
        
        /* Custom Alert */
        .custom-alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 46, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .custom-alert {
            background: var(--text-light);
            border-radius: 20px;
            padding: 30px 25px;
            max-width: 320px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .custom-alert.show {
            transform: scale(1);
            opacity: 1;
        }

        .custom-alert-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            color: var(--text-light);
        }

        .custom-alert-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .custom-alert-message {
            font-size: 14px;
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 25px;
        }

        .custom-alert-btn {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
            color: var(--text-light);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        /* Refer Page */
        .refer-details {
            text-align: center;
            margin-bottom: 30px;
        }

        .refer-details h3 {
            font-size: 18px;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .referral-code-box {
            background-color: #f0f0f0;
            padding: 15px 20px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 20px;
            display: inline-block;
            letter-spacing: 1px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }

        .referral-share-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .referral-share-buttons .btn {
            width: auto;
            padding: 10px 20px;
            font-size: 14px;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            text-align: center;
        }

        .referral-stat-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .referral-stat-item h4 {
            font-size: 22px;
            color: var(--primary-gold);
            margin-bottom: 5px;
        }

        .referral-stat-item p {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        /* Withdraw Page */
        .withdraw-form label {
            display: block;
            font-size: 14px;
            color: var(--text-dark);
            margin-bottom: 8px;
            font-weight: 600;
        }

        .withdraw-form select,
        .withdraw-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 15px;
            background-color: #fefefe;
            color: var(--text-dark);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .withdraw-form input:focus,
        .withdraw-form select:focus {
            border-color: var(--primary-gold);
            outline: none;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.2);
        }

        .withdraw-history-title {
            font-size: 18px;
            color: var(--text-dark);
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .withdraw-history-list {
            list-style: none;
            padding: 0;
        }

        .withdraw-history-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .withdraw-history-item-details {
            flex-grow: 1;
        }

        .withdraw-history-item h4 {
            font-size: 16px;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .withdraw-history-item p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .withdraw-status {
            font-size: 13px;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 8px;
            white-space: nowrap;
        }

        .status-pending { background-color: #ffeb3b; color: #795548; }
        .status-approved { background-color: #4CAF50; color: #ffffff; }
        .status-rejected { background-color: #F44336; color: #ffffff; }

        /* Profile Page */
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-picture {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid var(--primary-gold);
            margin-bottom: 15px;
            object-fit: cover;
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.2);
        }

        .profile-name {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        .profile-id {
            font-size: 14px;
            color: var(--text-muted);
        }

        .profile-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .profile-stat-item {
            background: #ffffff;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .profile-stat-item h4 {
            font-size: 20px;
            color: var(--primary-gold);
            margin-bottom: 5px;
        }

        .profile-stat-item p {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .profile-actions .btn {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <img id="headerProfilePic" src="https://placehold.co/80x80/1a1a2e/f39c12?text=U" alt="Profile" class="header-profile">
                <div class="header-info">
                    <h3 id="userName">User</h3>
                    <p>
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v4h-2zm0 6h2v2h-2z"></path></svg>
                        <span id="headerBalanceValue">0</span>
                        <span>(~<span id="headerDollarValue">0.00</span>$)</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Home Page -->
        <div id="homePage" class="page active">
            <div class="balance-card">
                <div class="balance-header">
                     <div class="balance-info">
                        <h3>Total Balance</h3>
                        <p class="dollar-equivalent">≈ $<span id="totalDollarAmount">0.00</span></p>
                    </div>
                    <div class="balance-amount">
                       <span id="totalBalanceAmount">0</span>
                       <svg class="icon-lg" style="color: var(--primary-gold)" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-12h2v4h-2zm0 6h2v2h-2z"></path></svg>
                    </div>
                </div>
                <div class="balance-stats">
                    <div class="balance-stat">
                        <h4><span id="balanceTotal">0</span></h4>
                        <p>Current Points</p>
                    </div>
                    <div class="balance-stat">
                        <h4><span id="balanceEarning">0</span></h4>
                        <p>Total Earned</p>
                    </div>
                </div>
            </div>

            <div class="card">
                 <div class="card-header">
                    <h3>Daily Tasks</h3>
                    <div class="card-icon">
                        <svg class="icon-lg" style="color: var(--primary-gold)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                    </div>
                </div>
                <p class="card-desc">Complete your daily tasks by watching ads to earn points.</p>
                <button class="btn btn-primary" onclick="navigateToPage('adsPage')">Start Earning</button>
            </div>
            
             <div class="card">
                 <div class="card-header">
                    <h3>Invite Friends</h3>
                    <div class="card-icon">
                         <svg class="icon-lg" style="color: var(--primary-gold)" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                    </div>
                </div>
                <p class="card-desc">Get a percentage of their earnings forever when you invite your friends!</p>
                <button class="btn btn-secondary" onclick="navigateToPage('referPage')">Invite Now</button>
            </div>
        </div>

        <!-- Ads Task Page -->
        <div id="adsPage" class="page">
            <div class="card">
                <div class="overview-header" style="text-align:center; margin-bottom: 20px;">
                    <h2>Ads Task Overview</h2>
                </div>
                <div class="task-overview">
                    <div class="overview-item">
                        <h3 id="dailyTasksCompleted">0/0</h3>
                        <p>Tasks Today</p>
                         <div class="task-progress-bar">
                           <div id="taskProgressBar" class="progress"></div>
                        </div>
                    </div>
                    <div class="overview-item">
                        <h3><span id="adsCurrentBalance">0</span></h3>
                        <p>Current Points</p>
                    </div>
                </div>
            </div>
            <div class="task-actions">
                 <button class="btn btn-primary" id="startTaskBtn">
                    <svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                    Watch Ad & Earn (<span id="standardAdPoints">0</span> pts)
                </button>
                <button class="btn btn-secondary" id="watchRewardedAdBtn">
                     <svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.11-.9-2-2-2zm-2 14H6V8h12v10z"></path></svg>
                    Watch Bonus Ad (<span id="bonusAdPoints">0</span> pts)
                </button>
            </div>

            <div class="card task-list-container">
                <div class="card-header">
                    <h3>Other Earning Tasks</h3>
                </div>
                <div id="dynamicTasksList">
                    <!-- Dynamic tasks will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Refer Page -->
        <div id="referPage" class="page">
             <div class="card">
                <div class="overview-header" style="text-align:center; margin-bottom: 20px;">
                    <h2>Invite Friends & Earn More!</h2>
                    <p class="card-desc" style="margin-top:15px;">Share your referral code and earn a percentage of your friends' earnings.</p>
                </div>
                <div class="refer-details">
                    <h3>Your Referral Code:</h3>
                    <div class="referral-code-box" id="userReferralCode">LOADING...</div>
                    <button class="btn btn-primary" id="copyReferralCodeBtn">
                         <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                        Copy Code
                    </button>
                    <div class="referral-share-buttons" style="margin-top: 15px;">
                        <button class="btn btn-secondary" id="shareOnTelegramBtn">
                            <svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.241 8.809l-2.733 12.872c-.144.646-.516.804-1.077.513l-4.148-3.085-1.996 1.921c-.22.213-.393.385-.758.385l.23-.974 4.326-4.049 4.96-7.85c.218-.352-.063-.535-.477-.384l-6.19 3.868-4.072-1.272c-.633-.198-.992-.303-.98-.644.004-.11.134-.202.408-.315.617-.257 12.409-4.57 13.064-4.82.72-.27 1.341.171 1.054.78z"></path></svg>
                            Telegram
                        </button>
                        <!-- Add more share buttons as needed -->
                    </div>
                </div>
                <p class="card-desc">You earn <span id="referralPercentage">0%</span> of your referred friends' earnings!</p>
                <div class="referral-stats">
                    <div class="referral-stat-item">
                        <h4 id="referredUsersCount">0</h4>
                        <p>Total Friends Invited</p>
                    </div>
                    <div class="referral-stat-item">
                        <h4 id="referralPointsEarned">0</h4>
                        <p>Points from Referrals</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdraw Page -->
        <div id="withdrawPage" class="page">
             <div class="card">
                <div class="overview-header" style="text-align:center; margin-bottom: 20px;">
                    <h2>Withdraw Your Earnings</h2>
                    <p class="card-desc" style="margin-top:15px;">Your current balance: <span id="withdrawCurrentBalance">0</span> points</p>
                    <p class="card-desc">Minimum withdrawal amount: <span id="minWithdrawAmount">0</span> points</p>
                </div>
                <div class="withdraw-form">
                    <label for="paymentMethod">Select Payment Method</label>
                    <select id="paymentMethod">
                        <!-- Options will be loaded from admin panel -->
                    </select>

                    <label for="withdrawAmount">Amount to Withdraw (Points)</label>
                    <input type="number" id="withdrawAmount" placeholder="Enter points to withdraw" min="0">

                    <label for="paymentAddress">Payment Address / Account Number</label>
                    <input type="text" id="paymentAddress" placeholder="e.g., wallet address, phone number">

                    <button class="btn btn-primary" id="submitWithdrawBtn">Submit Withdrawal Request</button>
                </div>

                <h3 class="withdraw-history-title">Withdrawal History</h3>
                <ul id="withdrawHistoryList" class="withdraw-history-list">
                    <!-- Withdrawal history items will be loaded here -->
                </ul>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="page">
             <div class="card">
                <div class="profile-header">
                    <img id="profilePagePic" src="https://placehold.co/100x100/1a1a2e/f39c12?text=U" alt="Profile" class="profile-picture">
                    <h2 class="profile-name" id="profilePageName">User Name</h2>
                    <p class="profile-id">ID: <span id="profilePageId">N/A</span></p>
                </div>

                <div class="profile-stats-grid">
                    <div class="profile-stat-item">
                        <h4><span id="profileBalance">0</span></h4>
                        <p>Current Balance</p>
                    </div>
                    <div class="profile-stat-item">
                        <h4><span id="profileTotalEarnings">0</span></h4>
                        <p>Total Earned</p>
                    </div>
                    <div class="profile-stat-item">
                        <h4><span id="profileReferralEarnings">0</span></h4>
                        <p>Referral Earnings</p>
                    </div>
                    <div class="profile-stat-item">
                        <h4><span id="profileDailyTasks">0/0</span></h4>
                        <p>Tasks Today</p>
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="btn btn-secondary" onclick="navigateToPage('adsPage')">View Tasks</button>
                    <button class="btn btn-secondary" onclick="navigateToPage('withdrawPage')">Make Withdrawal</button>
                </div>
            </div>
        </div>


        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="homePage">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item" data-page="adsPage">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 8V7l-3 2-3-2v1l3 2 3-2zm1-5H2C.9 3 0 3.9 0 5v14c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8 6c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H2v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V18zm6-1.5c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"></path></svg>
                <div class="nav-label">Tasks</div>
            </div>
            <div class="nav-item" data-page="referPage">
                 <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"></path></svg>
                <div class="nav-label">Refer</div>
            </div>
            <div class="nav-item" data-page="withdrawPage">
                 <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
                <div class="nav-label">Withdraw</div>
            </div>
            <div class="nav-item" data-page="profilePage">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                <div class="nav-label">Profile</div>
            </div>
        </div>
    </div>

    <div class="custom-alert-overlay" id="customAlertOverlay">
        <div class="custom-alert" id="customAlert">
            <div class="custom-alert-icon" id="customAlertIcon">🎉</div>
            <div class="custom-alert-title" id="customAlertTitle">Success!</div>
            <div class="custom-alert-message" id="customAlertMessage">Operation completed.</div>
            <button class="custom-alert-btn" onclick="closeCustomAlert()">OK</button>
        </div>
    </div>

    <!-- Timer Modal for Link-based Tasks -->
    <div class="custom-alert-overlay" id="taskTimerOverlay">
        <div class="custom-alert">
            <div class="custom-alert-icon" id="taskTimerIcon">⏳</div>
            <div class="custom-alert-title" id="taskTimerTitle">Task In Progress</div>
            <div class="custom-alert-message" id="taskTimerMessage">Please wait for <span id="taskTimerCountdown">15</span> seconds.</div>
            <button class="custom-alert-btn" id="claimTaskPointsBtn" style="display:none;">Claim Points</button>
        </div>
    </div>


    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const defaultProfilePic = 'https://placehold.co/80x80/1a1a2e/f39c12?text=U';
        
        // Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics(); // If you enabled analytics

        let currentUser = null; // To store user data from Firestore
        let appConfig = null;   // To store app-wide configurations from Admin Panel

        // Helper Functions
        function pointsToDollar(points) {
            if (!appConfig || !appConfig.dollarExchangeRate) return (points / 1000).toFixed(2); // Default if config not loaded
            return (points / appConfig.dollarExchangeRate).toFixed(2);
        }
        
        function checkDailyReset(userData) {
            const today = new Date().toDateString();
            if (userData.lastTaskDate !== today) {
                db.collection('users').doc(userData.userId).update({
                    dailyTasksCompleted: 0,
                    lastTaskDate: today
                })
                .then(() => {
                    console.log("Daily tasks reset successfully.");
                    currentUser.dailyTasksCompleted = 0;
                    currentUser.lastTaskDate = today;
                    updateUI();
                })
                .catch(error => {
                    console.error("Error resetting daily tasks: ", error);
                });
            }
        }

        async function fetchAppConfig() {
            try {
                const doc = await db.collection('config').doc('appConfig').get();
                if (doc.exists) {
                    appConfig = doc.data();
                    console.log("App configuration loaded:", appConfig);
                } else {
                    console.log("No app configuration found, setting defaults.");
                    // Set sensible defaults if no config exists
                    appConfig = {
                        standardAdPoints: 10,
                        bonusAdPoints: 20,
                        dailyTaskLimit: 50,
                        dollarExchangeRate: 1000, // 1000 points = $1
                        referralPercentage: 10, // 10% of referred user's earnings
                        minWithdrawAmount: 5000,
                        paymentMethods: [
                            { id: 'payeer', name: 'Payeer' },
                            { id: 'usdt', name: 'USDT (TRC20)' },
                            { id: 'bkash', name: 'Bkash' }
                        ],
                        dynamicTasks: [] // Admin can add tasks here
                    };
                    // Save default config to Firestore for the first time
                    await db.collection('config').doc('appConfig').set(appConfig);
                }
                updateUI(); // Update UI after config is loaded
            } catch (error) {
                console.error("Error fetching app config:", error);
            }
        }

        // UI Update Functions
        function updateUI() {
            if (!currentUser || !appConfig) return; // Wait until both are loaded

            // User info
            const userDataFromTelegram = tg.initDataUnsafe.user;
            if (userDataFromTelegram) {
                const fullName = `${userDataFromTelegram.first_name || ''} ${userDataFromTelegram.last_name || ''}`.trim() || 'User';
                const photoUrl = userDataFromTelegram.photo_url || defaultProfilePic;
                document.getElementById('headerProfilePic').src = photoUrl;
                document.getElementById('userName').textContent = fullName;
            }

            // Balances
            document.getElementById('headerBalanceValue').textContent = currentUser.balance.toLocaleString();
            document.getElementById('headerDollarValue').textContent = pointsToDollar(currentUser.balance);
            document.getElementById('totalBalanceAmount').textContent = currentUser.balance.toLocaleString();
            document.getElementById('totalDollarAmount').textContent = pointsToDollar(currentUser.balance);
            document.getElementById('balanceTotal').textContent = currentUser.balance.toLocaleString();
            document.getElementById('balanceEarning').textContent = currentUser.totalEarnings.toLocaleString();
            document.getElementById('adsCurrentBalance').textContent = currentUser.balance.toLocaleString();
            document.getElementById('withdrawCurrentBalance').textContent = currentUser.balance.toLocaleString();

            // Task page updates
            document.getElementById('standardAdPoints').textContent = appConfig.standardAdPoints;
            document.getElementById('bonusAdPoints').textContent = appConfig.bonusAdPoints;

            const tasksCompletedText = `${currentUser.dailyTasksCompleted}/${appConfig.dailyTaskLimit}`;
            document.getElementById('dailyTasksCompleted').textContent = tasksCompletedText;
            
            const progressPercentage = (currentUser.dailyTasksCompleted / appConfig.dailyTaskLimit) * 100;
            document.getElementById('taskProgressBar').style.width = `${progressPercentage}%`;

            // Disable buttons if limit is reached
            const limitReached = currentUser.dailyTasksCompleted >= appConfig.dailyTaskLimit;
            document.getElementById('startTaskBtn').disabled = limitReached;
            document.getElementById('watchRewardedAdBtn').disabled = limitReached;
            if (limitReached) {
                document.getElementById('startTaskBtn').innerHTML = `<svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg> Daily Limit Reached`;
                document.getElementById('watchRewardedAdBtn').innerHTML = `<svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.11-.9-2-2-2zm-2 14H6V8h12v10z"></path></svg> Daily Limit Reached`;
            } else {
                 document.getElementById('startTaskBtn').innerHTML = `<svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg> Watch Ad & Earn (${appConfig.standardAdPoints} pts)`;
                 document.getElementById('watchRewardedAdBtn').innerHTML = `<svg class="icon-lg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-2 .89-2 2v12c0 1.1.89 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.11-.9-2-2-2zm-2 14H6V8h12v10z"></path></svg> Watch Bonus Ad (${appConfig.bonusAdPoints} pts)`;
            }

            // Refer Page Update
            document.getElementById('userReferralCode').textContent = currentUser.referralCode || 'N/A';
            document.getElementById('referralPercentage').textContent = (appConfig.referralPercentage || 0) + '%';
            document.getElementById('referredUsersCount').textContent = currentUser.referredUsersCount || 0;
            document.getElementById('referralPointsEarned').textContent = currentUser.referralEarnings ? currentUser.referralEarnings.toLocaleString() : 0;

            // Withdraw Page Update
            document.getElementById('minWithdrawAmount').textContent = appConfig.minWithdrawAmount.toLocaleString();
            populatePaymentMethods();
            renderWithdrawalHistory(); // Render user's withdrawal history

            // Profile Page Update
            if (userDataFromTelegram) {
                document.getElementById('profilePagePic').src = userDataFromTelegram.photo_url || defaultProfilePic;
                document.getElementById('profilePageName').textContent = `${userDataFromTelegram.first_name || ''} ${userDataFromTelegram.last_name || ''}`.trim() || 'User';
                document.getElementById('profilePageId').textContent = currentUser.userId;
            }
            document.getElementById('profileBalance').textContent = currentUser.balance.toLocaleString();
            document.getElementById('profileTotalEarnings').textContent = currentUser.totalEarnings.toLocaleString();
            document.getElementById('profileReferralEarnings').textContent = currentUser.referralEarnings ? currentUser.referralEarnings.toLocaleString() : 0;
            document.getElementById('profileDailyTasks').textContent = tasksCompletedText;

            renderDynamicTasks(); // Render any dynamic tasks
        }

        // Custom Alert Functions
        function showCustomAlert(title, message, icon = '🎉') {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            document.getElementById('customAlertIcon').textContent = icon;
            
            const overlay = document.getElementById('customAlertOverlay');
            const alertBox = document.getElementById('customAlert');
            
            overlay.style.display = 'flex';
            setTimeout(() => alertBox.classList.add('show'), 10);
        }

        function closeCustomAlert() {
            const overlay = document.getElementById('customAlertOverlay');
            const alertBox = document.getElementById('customAlert');
            
            alertBox.classList.remove('show');
            setTimeout(() => overlay.style.display = 'none', 300);
        }

        // Task Timer Modal Functions
        let timerInterval;
        let currentTaskLink = null;
        let currentTaskPoints = 0;
        let currentTaskId = null;

        function showTaskTimer(duration, link, points, taskId) {
            currentTaskLink = link;
            currentTaskPoints = points;
            currentTaskId = taskId;
            
            const timerOverlay = document.getElementById('taskTimerOverlay');
            const timerCountdown = document.getElementById('taskTimerCountdown');
            const claimBtn = document.getElementById('claimTaskPointsBtn');

            timerCountdown.textContent = duration;
            claimBtn.style.display = 'none'; // Hide claim button initially
            claimBtn.disabled = true;

            timerOverlay.style.display = 'flex';
            setTimeout(() => document.getElementById('taskTimerOverlay').querySelector('.custom-alert').classList.add('show'), 10);

            // Open the link in a new tab/window
            if (currentTaskLink) {
                window.open(currentTaskLink, '_blank');
            }

            let timeLeft = duration;
            timerInterval = setInterval(() => {
                timeLeft--;
                timerCountdown.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerCountdown.textContent = '0';
                    document.getElementById('taskTimerTitle').textContent = 'Task Completed!';
                    document.getElementById('taskTimerMessage').textContent = 'You can now claim your points.';
                    claimBtn.style.display = 'block';
                    claimBtn.disabled = false;
                }
            }, 1000);
        }

        function closeTaskTimer() {
            clearInterval(timerInterval);
            document.getElementById('taskTimerOverlay').querySelector('.custom-alert').classList.remove('show');
            setTimeout(() => document.getElementById('taskTimerOverlay').style.display = 'none', 300);
        }

        document.getElementById('claimTaskPointsBtn').addEventListener('click', async () => {
            closeTaskTimer();
            if (currentTaskId && currentUser.userId && currentTaskPoints > 0) {
                try {
                    const taskRef = db.collection('config').doc('appConfig');
                    const configDoc = await taskRef.get();
                    if (configDoc.exists) {
                        const configData = configDoc.data();
                        // Find the task by currentTaskId
                        const taskIndex = configData.dynamicTasks.findIndex(t => t.id === currentTaskId);
                        if (taskIndex !== -1) {
                            // Mark task as completed for today for this user
                            const today = new Date().toDateString();
                            const userTaskKey = `tasks.${currentTaskId}.${today}`;
                            await db.collection('users').doc(currentUser.userId).update({
                                balance: firebase.firestore.FieldValue.increment(currentTaskPoints),
                                totalEarnings: firebase.firestore.FieldValue.increment(currentTaskPoints),
                                [`completedTasks.${currentTaskId}`]: today // Track completion date per task
                            });

                            currentUser.balance += currentTaskPoints;
                            currentUser.totalEarnings += currentTaskPoints;
                            // Update local tracking for dynamic tasks
                            if (!currentUser.completedTasks) currentUser.completedTasks = {};
                            currentUser.completedTasks[currentTaskId] = today;
                            
                            // Check for referral earnings if applicable
                            if (currentUser.referredBy && appConfig.referralPercentage > 0) {
                                const referralBonus = Math.round(currentTaskPoints * (appConfig.referralPercentage / 100));
                                await db.collection('users').doc(currentUser.referredBy).update({
                                    balance: firebase.firestore.FieldValue.increment(referralBonus),
                                    referralEarnings: firebase.firestore.FieldValue.increment(referralBonus)
                                });
                                console.log(`Referral bonus of ${referralBonus} points given to ${currentUser.referredBy}`);
                            }

                            updateUI();
                            showCustomAlert('Task Claimed!', `You earned ${currentTaskPoints} points!`, '💰');
                            tg.HapticFeedback.notificationOccurred('success');
                        } else {
                            showCustomAlert('Error', 'Task not found or already claimed.', '❌');
                        }
                    }
                } catch (error) {
                    console.error("Error claiming dynamic task points:", error);
                    showCustomAlert('Error', 'Failed to claim points. Please try again.', '❌');
                }
            } else {
                showCustomAlert('Error', 'Invalid task data.', '❌');
            }
        });


        // Reward Functions (for ads)
        async function rewardUser(points, isAdTask = true) {
            if (!currentUser || !appConfig) {
                showCustomAlert('Error', 'App data not loaded. Please try again.', '❌');
                return;
            }

            checkDailyReset(currentUser); // Ensure daily tasks are reset if needed

            if (currentUser.dailyTasksCompleted >= appConfig.dailyTaskLimit && isAdTask) {
                showCustomAlert('Limit Reached', 'You have completed all daily tasks. Please come back tomorrow!', '⏰');
                return;
            }

            try {
                // Update user's balance and earnings
                await db.collection('users').doc(currentUser.userId).update({
                    balance: firebase.firestore.FieldValue.increment(points),
                    totalEarnings: firebase.firestore.FieldValue.increment(points),
                    dailyTasksCompleted: firebase.firestore.FieldValue.increment(1) // Only increment for ad tasks
                });

                currentUser.balance += points;
                currentUser.totalEarnings += points;
                currentUser.dailyTasksCompleted++;

                // Check for referral earnings if applicable
                if (currentUser.referredBy && appConfig.referralPercentage > 0) {
                    const referralBonus = Math.round(points * (appConfig.referralPercentage / 100));
                    await db.collection('users').doc(currentUser.referredBy).update({
                        balance: firebase.firestore.FieldValue.increment(referralBonus),
                        referralEarnings: firebase.firestore.FieldValue.increment(referralBonus)
                    });
                    console.log(`Referral bonus of ${referralBonus} points given to ${currentUser.referredBy}`);
                }

                updateUI();
                showCustomAlert('Task Completed!', `You earned ${points} points! ${appConfig.dailyTaskLimit - currentUser.dailyTasksCompleted} daily tasks remaining.`, '💰');
                tg.HapticFeedback.notificationOccurred('success');
            } catch (error) {
                console.error("Error rewarding user:", error);
                showCustomAlert('Error', 'Failed to update points. Please try again.', '❌');
            }
        }

        // Navigation Logic
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');

        function navigateToPage(pageId) {
             pages.forEach(p => p.classList.remove('active'));
             document.getElementById(pageId).classList.add('active');

             navItems.forEach(item => {
                if (item.dataset.page === pageId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
             });
        }

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                navigateToPage(item.dataset.page);
            });
        });

        // Event Listeners for Ad Tasks
        document.getElementById('startTaskBtn').addEventListener('click', function() {
            checkDailyReset(currentUser); // Ensure daily tasks are reset if needed
            if (currentUser.dailyTasksCompleted >= appConfig.dailyTaskLimit) {
                showCustomAlert('Limit Reached', 'You have completed all daily tasks. Please come back tomorrow!', '⏰');
                return;
            }

            // Show standard interstitial ad
            if (typeof show_10058398 === 'function') {
                show_10058398().then(() => {
                    rewardUser(appConfig.standardAdPoints, true); // Reward standard ad points
                }).catch(e => {
                    console.error("Standard ad failed:", e);
                    showCustomAlert('Ad Error', 'The ad failed to load. Please try again in a moment.', '❌');
                    tg.HapticFeedback.notificationOccurred('error');
                });
            } else {
                console.warn("Ad SDK function (show_10058398) not found. Simulating ad watch.");
                // Simulate ad watch for testing if SDK not loaded
                setTimeout(() => {
                    rewardUser(appConfig.standardAdPoints, true);
                }, 2000);
            }
        });

        document.getElementById('watchRewardedAdBtn').addEventListener('click', function() {
            checkDailyReset(currentUser); // Ensure daily tasks are reset if needed
            if (currentUser.dailyTasksCompleted >= appConfig.dailyTaskLimit) {
                showCustomAlert('Limit Reached', 'You have completed all daily tasks. Please come back tomorrow!', '⏰');
                return;
            }

            // Show rewarded popup ad
            if (typeof show_10058398 === 'function') {
                show_10058398('pop').then(() => {
                    rewardUser(appConfig.bonusAdPoints, true); // Reward bonus ad points
                }).catch(e => {
                    console.error("Rewarded ad failed:", e);
                    showCustomAlert('Ad Not Available', 'The bonus ad is not available right now. Please try again later.', '⏳');
                    tg.HapticFeedback.notificationOccurred('warning');
                });
            } else {
                console.warn("Ad SDK function (show_10058398) not found. Simulating rewarded ad watch.");
                // Simulate ad watch for testing if SDK not loaded
                setTimeout(() => {
                    rewardUser(appConfig.bonusAdPoints, true);
                }, 2000);
            }
        });

        // Refer Page event listener (Copy button)
        document.getElementById('copyReferralCodeBtn').addEventListener('click', async () => {
            const referralCode = document.getElementById('userReferralCode').textContent;
            try {
                await navigator.clipboard.writeText(referralCode);
                showCustomAlert('Copied!', 'Referral code copied to clipboard.', '📋');
                tg.HapticFeedback.notificationOccurred('success');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showCustomAlert('Error', 'Failed to copy code. Please try manually.', '❌');
            }
        });

        // Refer Page event listener (Share on Telegram)
        document.getElementById('shareOnTelegramBtn').addEventListener('click', () => {
            const referralCode = document.getElementById('userReferralCode').textContent;
            const message = `Hey! Join this awesome earning app and start earning points by watching ads and completing tasks. Use my referral code: ${referralCode} to get a bonus! [App Link Here - Replace with your actual app link]`;
            const telegramShareUrl = `https://t.me/share/url?url=${encodeURIComponent('YOUR_APP_TG_BOT_LINK_HERE')}&text=${encodeURIComponent(message)}`;
            window.open(telegramShareUrl, '_blank');
            showCustomAlert('Share', 'Telegram share initiated!', '🚀');
        });

        // Withdrawal Page Functions
        function populatePaymentMethods() {
            const selectElement = document.getElementById('paymentMethod');
            selectElement.innerHTML = ''; // Clear existing options
            if (appConfig && appConfig.paymentMethods && appConfig.paymentMethods.length > 0) {
                appConfig.paymentMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.id;
                    option.textContent = method.name;
                    selectElement.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No payment methods available';
                option.disabled = true;
                selectElement.appendChild(option);
            }
        }

        async function renderWithdrawalHistory() {
            const historyList = document.getElementById('withdrawHistoryList');
            historyList.innerHTML = ''; // Clear existing history

            if (!currentUser || !currentUser.userId) return;

            try {
                const withdrawalsSnapshot = await db.collection('withdrawals')
                                                    .where('userId', '==', currentUser.userId)
                                                    .orderBy('timestamp', 'desc')
                                                    .get();
                
                if (withdrawalsSnapshot.empty) {
                    historyList.innerHTML = '<li class="card-desc" style="text-align:center;">No withdrawal history found.</li>';
                    return;
                }

                withdrawalsSnapshot.forEach(doc => {
                    const withdrawal = doc.data();
                    const listItem = document.createElement('li');
                    listItem.classList.add('withdraw-history-item');

                    let statusClass = '';
                    if (withdrawal.status === 'Pending') {
                        statusClass = 'status-pending';
                    } else if (withdrawal.status === 'Approved') {
                        statusClass = 'status-approved';
                    } else if (withdrawal.status === 'Rejected') {
                        statusClass = 'status-rejected';
                    }

                    const date = withdrawal.timestamp ? new Date(withdrawal.timestamp.toDate()).toLocaleString() : 'N/A';

                    listItem.innerHTML = `
                        <div class="withdraw-history-item-details">
                            <h4>${withdrawal.amount.toLocaleString()} points (${withdrawal.paymentMethodName})</h4>
                            <p>${withdrawal.paymentAddress}</p>
                            <p>${date}</p>
                        </div>
                        <span class="withdraw-status ${statusClass}">${withdrawal.status}</span>
                    `;
                    historyList.appendChild(listItem);
                });

            } catch (error) {
                console.error("Error fetching withdrawal history:", error);
                historyList.innerHTML = '<li class="card-desc" style="text-align:center; color:red;">Failed to load history.</li>';
            }
        }

        document.getElementById('submitWithdrawBtn').addEventListener('click', async () => {
            if (!currentUser || !appConfig) {
                showCustomAlert('Error', 'App data not loaded. Please try again.', '❌');
                return;
            }

            const paymentMethodId = document.getElementById('paymentMethod').value;
            const withdrawAmount = parseInt(document.getElementById('withdrawAmount').value);
            const paymentAddress = document.getElementById('paymentAddress').value.trim();

            if (!paymentMethodId || !withdrawAmount || !paymentAddress) {
                showCustomAlert('Error', 'Please fill in all withdrawal details.', '⚠️');
                return;
            }
            if (withdrawAmount <= 0 || isNaN(withdrawAmount)) {
                showCustomAlert('Error', 'Please enter a valid amount.', '⚠️');
                return;
            }
            if (withdrawAmount > currentUser.balance) {
                showCustomAlert('Error', 'Insufficient balance.', '❌');
                return;
            }
            if (withdrawAmount < appConfig.minWithdrawAmount) {
                showCustomAlert('Error', `Minimum withdrawal is ${appConfig.minWithdrawAmount} points.`, '⚠️');
                return;
            }

            const selectedMethod = appConfig.paymentMethods.find(m => m.id === paymentMethodId);
            const paymentMethodName = selectedMethod ? selectedMethod.name : paymentMethodId;

            try {
                // Deduct points from user's balance immediately
                await db.collection('users').doc(currentUser.userId).update({
                    balance: firebase.firestore.FieldValue.increment(-withdrawAmount)
                });
                currentUser.balance -= withdrawAmount; // Update local state

                // Add withdrawal request to 'withdrawals' collection
                await db.collection('withdrawals').add({
                    userId: currentUser.userId,
                    username: `${tg.initDataUnsafe.user.first_name || ''} ${tg.initDataUnsafe.user.last_name || ''}`.trim(),
                    amount: withdrawAmount,
                    paymentMethodId: paymentMethodId,
                    paymentMethodName: paymentMethodName,
                    paymentAddress: paymentAddress,
                    status: 'Pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                updateUI();
                showCustomAlert('Withdrawal Submitted!', 'Your request has been submitted and is awaiting approval.', '✅');
                tg.HapticFeedback.notificationOccurred('success');

                // Clear form fields
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('paymentAddress').value = '';

            } catch (error) {
                console.error("Error submitting withdrawal request:", error);
                showCustomAlert('Error', 'Failed to submit withdrawal request. Please try again.', '❌');
                tg.HapticFeedback.notificationOccurred('error');
            }
        });


        // Dynamic Tasks Rendering
        function renderDynamicTasks() {
            const dynamicTasksList = document.getElementById('dynamicTasksList');
            dynamicTasksList.innerHTML = ''; // Clear previous tasks

            if (!appConfig || !appConfig.dynamicTasks || appConfig.dynamicTasks.length === 0) {
                dynamicTasksList.innerHTML = '<p class="card-desc" style="text-align:center;">No additional tasks available right now.</p>';
                return;
            }

            appConfig.dynamicTasks.forEach(task => {
                const today = new Date().toDateString();
                const isCompletedToday = currentUser.completedTasks && currentUser.completedTasks[task.id] === today;
                
                const taskItem = document.createElement('div');
                taskItem.classList.add('task-item');
                taskItem.innerHTML = `
                    <div class="task-item-info">
                        <h4>${task.name}</h4>
                        <p>${task.description} - Earn ${task.points} points in ${task.timer} seconds</p>
                    </div>
                    <button class="dynamic-task-btn" data-task-id="${task.id}" ${isCompletedToday ? 'disabled' : ''}>
                        ${isCompletedToday ? 'Completed' : 'Start Task'}
                    </button>
                `;
                dynamicTasksList.appendChild(taskItem);
            });

            // Add event listeners for new dynamic task buttons
            document.querySelectorAll('.dynamic-task-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const taskId = event.target.dataset.taskId;
                    const task = appConfig.dynamicTasks.find(t => t.id === taskId);
                    if (task) {
                        showTaskTimer(task.timer, task.link, task.points, task.id);
                    }
                });
            });
        }


        // Main Initialization Function
        async function initApp() {
            // 1. Fetch App Configuration from Firestore
            await fetchAppConfig();

            // 2. Authenticate User (or create if new)
            const userDataFromTelegram = tg.initDataUnsafe.user;
            if (!userDataFromTelegram || !userDataFromTelegram.id) {
                showCustomAlert('Error', 'Could not get Telegram user data. Please open from Telegram.', '❌');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            const userId = String(userDataFromTelegram.id); // Ensure userId is string

            try {
                const userDocRef = db.collection('users').doc(userId);
                const userDoc = await userDocRef.get();

                if (userDoc.exists) {
                    currentUser = userDoc.data();
                    console.log("Existing user loaded:", currentUser);
                } else {
                    // Create new user
                    const initialBalance = 0; // New users start with 0 points by default
                    const referralCode = Math.random().toString(36).substring(2, 8).toUpperCase(); // Simple unique code

                    currentUser = {
                        userId: userId,
                        first_name: userDataFromTelegram.first_name || '',
                        last_name: userDataFromTelegram.last_name || '',
                        username: userDataFromTelegram.username || '',
                        photo_url: userDataFromTelegram.photo_url || defaultProfilePic,
                        balance: initialBalance,
                        totalEarnings: initialBalance,
                        dailyTasksCompleted: 0,
                        lastTaskDate: new Date().toDateString(),
                        referralCode: referralCode,
                        referredBy: null, // To be set if user came via referral link
                        referralEarnings: 0,
                        referredUsersCount: 0,
                        completedTasks: {} // For dynamic tasks tracking
                    };

                    // Check if there's a referrer from initData
                    const urlParams = new URLSearchParams(tg.initData);
                    const startParam = urlParams.get('start'); // This usually contains custom data, e.g., 'ref_REFERRALCODE'
                    
                    if (startParam && startParam.startsWith('ref_')) {
                        const referrerCode = startParam.substring(4);
                        console.log("Referrer code from URL:", referrerCode);
                        const referrerSnapshot = await db.collection('users').where('referralCode', '==', referrerCode).limit(1).get();
                        if (!referrerSnapshot.empty) {
                            const referrer = referrerSnapshot.docs[0].data();
                            currentUser.referredBy = referrer.userId;
                            // Increment referrer's referredUsersCount
                            await db.collection('users').doc(referrer.userId).update({
                                referredUsersCount: firebase.firestore.FieldValue.increment(1)
                            });
                            console.log(`User ${userId} was referred by ${referrer.userId}`);
                        }
                    }

                    await userDocRef.set(currentUser);
                    console.log("New user created:", currentUser);
                    showCustomAlert('Welcome!', 'Your account has been created successfully.', '👋');
                    tg.HapticFeedback.notificationOccurred('success');
                }

                // Check for daily reset immediately after user data is loaded
                checkDailyReset(currentUser);
                updateUI(); // Update UI with initial user data and config

                // Listen for real-time updates to the current user's document
                userDocRef.onSnapshot(doc => {
                    if (doc.exists) {
                        currentUser = doc.data();
                        console.log("User data updated in real-time:", currentUser);
                        updateUI();
                        // Re-check daily reset in case date changed while app was open
                        checkDailyReset(currentUser);
                    } else {
                        console.error("User document not found for real-time update.");
                        // Handle case where user might be deleted or an error occurs
                    }
                }, error => {
                    console.error("Error listening to user document:", error);
                });

                // Also listen to app config changes in real-time
                db.collection('config').doc('appConfig').onSnapshot(doc => {
                    if (doc.exists) {
                        appConfig = doc.data();
                        console.log("App config updated in real-time:", appConfig);
                        updateUI();
                    } else {
                        console.warn("App config document not found during real-time listen.");
                    }
                }, error => {
                    console.error("Error listening to app config:", error);
                });

            } catch (error) {
                console.error("Error during user initialization:", error);
                showCustomAlert('Error', 'Failed to load user data. Please try again.', '❌');
                tg.HapticFeedback.notificationOccurred('error');
            }
        }

        // Initial Load
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
